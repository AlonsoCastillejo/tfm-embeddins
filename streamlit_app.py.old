import streamlit as st
import pandas as pd
import os
import shutil
import sys
from datetime import datetime
import json

# AÃ±adir src al path para imports
sys.path.append('./src')

from src.data_processor import DataProcessor
from src.embeddings_manager import EmbeddingsManager
from src.database_manager import DatabaseManager
from src.search_engine import PropertySearchEngine
from src.query_enhancer import QueryEnhancer
from src.config import Config

# ConfiguraciÃ³n de pÃ¡gina
st.set_page_config(
    page_title="Sistema de BÃºsqueda Inmobiliaria",
    page_icon="ğŸ ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS personalizado
st.markdown("""
<style>
    .main-header {
        font-size: 3rem;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 2rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .property-card {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: white;
    }

    .property-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .property-price {
        font-size: 1.5rem;
        font-weight: bold;
        color: #e74c3c;
        margin-bottom: 0.5rem;
    }

    .property-details {
        color: #7f8c8d;
        margin-bottom: 0.5rem;
    }

    .relevance-score {
        background: linear-gradient(90deg, #3498db, #2ecc71);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 15px;
        font-size: 0.9rem;
        font-weight: bold;
    }

    .llm-analysis {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 5px;
    }

    .filter-tag {
        background: #17a2b8;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
        margin: 0.1rem;
        display: inline-block;
    }
</style>
""", unsafe_allow_html=True)

# Estado de la aplicaciÃ³n
if 'search_engine' not in st.session_state:
    st.session_state.search_engine = PropertySearchEngine()
    st.session_state.query_enhancer = QueryEnhancer()

def display_main_header():
    """Muestra el header principal"""
    st.markdown('<h1 class="main-header">Sistema de BÃºsqueda Inmobiliaria con IA</h1>', unsafe_allow_html=True)
    st.markdown("---")

def display_sidebar():
    """Sidebar con opciones y estadÃ­sticas"""
    st.sidebar.title("Panel de Control")

    # EstadÃ­sticas de la base de datos
    try:
        stats = st.session_state.search_engine.db_manager.get_collection_stats()
        st.sidebar.metric("Propiedades en BD", stats['total_properties'])
    except:
        st.sidebar.warning("Base de datos no inicializada")

    st.sidebar.markdown("---")

    # Opciones de gestiÃ³n
    st.sidebar.subheader("ğŸ“ GestiÃ³n de Datos")

    # Upload de CSV
    uploaded_file = st.sidebar.file_uploader(
        "Subir archivo CSV",
        type=['csv'],
        help="Sube un archivo CSV con datos de propiedades"
    )

    if uploaded_file is not None:
        if st.sidebar.button("ğŸš€ Procesar y Cargar"):
            process_uploaded_file(uploaded_file)

    # Borrar base de datos
    st.sidebar.markdown("---")
    st.sidebar.subheader("ğŸ—‘ï¸ Resetear Sistema")
    if st.sidebar.button("âš ï¸ Borrar Base de Datos", type="secondary"):
        if st.sidebar.checkbox("Confirmar eliminaciÃ³n"):
            reset_database()

def process_uploaded_file(uploaded_file):
    """Procesa el archivo CSV subido"""
    try:
        with st.spinner("ğŸ”„ Procesando archivo..."):
            # Guardar archivo temporalmente
            temp_path = f"/tmp/{uploaded_file.name}"
            with open(temp_path, "wb") as f:
                f.write(uploaded_file.getvalue())

            # Cargar y procesar datos
            df = pd.read_csv(temp_path)
            st.sidebar.success(f"âœ… Archivo cargado: {len(df)} registros")

            # Limpiar datos
            df_clean = DataProcessor.clean_dataframe(df)

            # Generar textos y metadata
            with st.spinner("ğŸ“ Generando textos descriptivos..."):
                descriptive_texts = df_clean.apply(DataProcessor.build_descriptive_text, axis=1).tolist()
                structured_metadata = df_clean.apply(DataProcessor.build_structured_metadata, axis=1).tolist()

            # Generar embeddings
            with st.spinner("ğŸ§  Generando embeddings..."):
                embeddings_manager = EmbeddingsManager()
                embeddings = embeddings_manager.generate_embeddings_batch(descriptive_texts, use_large_model=True)

            # Guardar en base de datos
            with st.spinner("ğŸ’¾ Guardando en base de datos..."):
                db_manager = DatabaseManager()
                db_manager.add_properties_to_db(df_clean, descriptive_texts, embeddings, structured_metadata)

            st.sidebar.success("ğŸ‰ Datos procesados y guardados correctamente!")
            st.rerun()

    except Exception as e:
        st.sidebar.error(f"âŒ Error procesando archivo: {str(e)}")

def reset_database():
    """Resetea la base de datos"""
    try:
        if os.path.exists(Config.CHROMADB_PATH):
            shutil.rmtree(Config.CHROMADB_PATH)
        st.sidebar.success("ğŸ—‘ï¸ Base de datos eliminada")
        st.rerun()
    except Exception as e:
        st.sidebar.error(f"âŒ Error: {str(e)}")

def display_llm_analysis(query_info, query):
    """Muestra el anÃ¡lisis del LLM"""
    st.markdown('<div class="llm-analysis">', unsafe_allow_html=True)
    st.markdown("### ğŸ¤– AnÃ¡lisis Inteligente de la Consulta")

    col1, col2 = st.columns([2, 1])

    with col1:
        st.markdown(f"**ğŸ’¬ Consulta original:** `{query}`")
        st.markdown(f"**ğŸ” Query optimizada:** `{query_info['semantic_query']}`")

    with col2:
        if query_info.get('filters'):
            st.markdown("**ğŸ¯ Filtros aplicados:**")
            for key, value in query_info['filters'].items():
                if key == 'precio_max' and value:
                    st.markdown(f'<span class="filter-tag">ğŸ’° Max: {value:,}â‚¬</span>', unsafe_allow_html=True)
                elif key == 'habitaciones' and value:
                    st.markdown(f'<span class="filter-tag">ğŸ›ï¸ {value} hab</span>', unsafe_allow_html=True)
                elif key == 'localidad' and value:
                    st.markdown(f'<span class="filter-tag">ğŸ“ {value}</span>', unsafe_allow_html=True)
                elif key == 'tipo' and value:
                    st.markdown(f'<span class="filter-tag">ğŸ  {value}</span>', unsafe_allow_html=True)

    st.markdown('</div>', unsafe_allow_html=True)

def display_property_card(result, index):
    """Muestra una tarjeta de propiedad"""
    doc = result['document']
    meta = result['metadata']
    relevance = result['relevance_score'] * 100

    with st.container():
        st.markdown('<div class="property-card">', unsafe_allow_html=True)

        # Header con tÃ­tulo y relevancia
        col1, col2 = st.columns([3, 1])

        with col1:
            # Extraer tÃ­tulo del documento
            doc_lines = [line.strip() for line in doc.split('\n') if line.strip()]
            titulo = doc_lines[0].replace("Propiedad: ", "") if doc_lines else "Sin tÃ­tulo"
            st.markdown(f'<div class="property-title">ğŸ  {titulo}</div>', unsafe_allow_html=True)

        with col2:
            st.markdown(f'<span class="relevance-score">ğŸ“Š {relevance:.1f}%</span>', unsafe_allow_html=True)

        # InformaciÃ³n principal
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            precio = meta.get('precio', 'Consultar')
            if isinstance(precio, (int, float)):
                precio_formatted = f"{precio:,.0f}â‚¬"
            else:
                precio_formatted = str(precio)
            st.markdown(f'<div class="property-price">ğŸ’° {precio_formatted}</div>', unsafe_allow_html=True)

        with col2:
            habitaciones = meta.get('Habitaciones', 'N/A')
            st.metric("ğŸ›ï¸ Habitaciones", habitaciones)

        with col3:
            banos = meta.get('BaÃ±os', 'N/A')
            st.metric("ğŸš¿ BaÃ±os", banos)

        with col4:
            metros = meta.get('metros', 'N/A')
            if isinstance(metros, (int, float)):
                metros_formatted = f"{metros}mÂ²"
            else:
                metros_formatted = str(metros)
            st.metric("ğŸ“ Superficie", metros_formatted)

        # UbicaciÃ³n
        barrio = meta.get('barrio', 'N/A')
        distrito = meta.get('distrito', 'N/A')
        localidad = meta.get('localidad', 'N/A')
        st.markdown(f'<div class="property-details">ğŸ“ {localidad} - {distrito} - {barrio}</div>', unsafe_allow_html=True)

        # CaracterÃ­sticas adicionales
        caracteristicas = []
        if meta.get('tipo'):
            caracteristicas.append(f"ğŸ  {meta['tipo']}")
        if meta.get('Planta'):
            caracteristicas.append(f"ğŸ¢ Planta {meta['Planta']}")
        if meta.get('Ascensor') == '1':
            caracteristicas.append("ğŸ—ï¸ Con ascensor")
        if meta.get('Exterior') == '1':
            caracteristicas.append("ğŸŒ Exterior")

        if caracteristicas:
            st.markdown(f'<div class="property-details">{" â€¢ ".join(caracteristicas)}</div>', unsafe_allow_html=True)

        # Precio por mÂ²
        if meta.get('precio_por_m2'):
            st.markdown(f'<div class="property-details">ğŸ’¹ {meta["precio_por_m2"]:.0f}â‚¬/mÂ²</div>', unsafe_allow_html=True)

        # DescripciÃ³n (si existe)
        descripcion_lines = [line for line in doc_lines if line.startswith('DescripciÃ³n:')]
        if descripcion_lines:
            descripcion = descripcion_lines[0].replace('DescripciÃ³n: ', '')
            if len(descripcion) > 200:
                descripcion = descripcion[:200] + "..."
            st.markdown(f"**ğŸ“ DescripciÃ³n:** {descripcion}")

        # URL
        if meta.get('url'):
            st.markdown(f"ğŸ”— [Ver detalles completos]({meta['url']})")

        # Score de completitud
        completeness = meta.get('completeness_score', 0) * 100
        st.progress(completeness/100, text=f"ğŸ“Š Completitud de datos: {completeness:.0f}%")

        st.markdown('</div>', unsafe_allow_html=True)

def main():
    """FunciÃ³n principal de la aplicaciÃ³n"""
    display_main_header()
    display_sidebar()

    # Ãrea principal de bÃºsqueda
    st.header("ğŸ” BÃºsqueda Inteligente de Propiedades")

    # Input de bÃºsqueda
    col1, col2 = st.columns([4, 1])

    with col1:
        query = st.text_input(
            "Â¿QuÃ© propiedad estÃ¡s buscando?",
            placeholder="Ej: piso barato en madrid con 3 habitaciones",
            help="Describe tu bÃºsqueda en lenguaje natural"
        )

    with col2:
        search_button = st.button("ğŸš€ Buscar", type="primary", use_container_width=True)

    # Opciones avanzadas
    with st.expander("âš™ï¸ Opciones Avanzadas"):
        col1, col2 = st.columns(2)
        with col1:
            num_results = st.slider("NÃºmero de resultados", 1, 10, 5)
            show_analysis = st.checkbox("Mostrar anÃ¡lisis LLM", value=True)
        with col2:
            test_mode = st.checkbox("Modo test (solo anÃ¡lisis)", value=False)

    # Procesamiento de bÃºsqueda
    if (search_button or query) and query.strip():
        try:
            # AnÃ¡lisis con LLM
            query_info = st.session_state.query_enhancer.get_enhanced_query_info(query, show_analysis=False)

            if show_analysis:
                display_llm_analysis(query_info, query)

            if not test_mode:
                # Realizar bÃºsqueda
                with st.spinner("ğŸ”„ Buscando propiedades..."):
                    results = st.session_state.search_engine.search(query, n_results=num_results)

                # Mostrar resultados
                if results:
                    st.markdown(f"### ğŸ¯ Encontrados {len(results)} resultados para: *'{query}'*")
                    st.markdown("---")

                    for i, result in enumerate(results):
                        display_property_card(result, i)
                        if i < len(results) - 1:
                            st.markdown("---")
                else:
                    st.warning(f"âŒ No se encontraron resultados para: '{query}'")
                    st.info("ğŸ’¡ Intenta con tÃ©rminos mÃ¡s generales o diferentes")

        except Exception as e:
            st.error(f"âŒ Error en la bÃºsqueda: {str(e)}")

    # Ejemplos de bÃºsqueda
    if not query:
        st.markdown("### ğŸ’¡ Ejemplos de bÃºsqueda:")
        col1, col2, col3 = st.columns(3)

        with col1:
            if st.button("ğŸ  Piso barato Madrid", use_container_width=True):
                st.session_state.example_query = "piso barato madrid con 3 habitaciones"

        with col2:
            if st.button("ğŸ¡ Casa familiar jardÃ­n", use_container_width=True):
                st.session_state.example_query = "casa moderna para familia con jardÃ­n"

        with col3:
            if st.button("ğŸ¢ Ãtico cÃ©ntrico", use_container_width=True):
                st.session_state.example_query = "Ã¡tico cÃ©ntrico barcelona con terraza"

        # Si se seleccionÃ³ un ejemplo, actualizar el input
        if 'example_query' in st.session_state:
            st.rerun()

    # Footer con informaciÃ³n
    st.markdown("---")
    st.markdown("""
    <div style='text-align: center; color: #7f8c8d; font-size: 0.9rem;'>
        ğŸ¤– Potenciado por IA â€¢ ğŸ” BÃºsqueda SemÃ¡ntica â€¢ ğŸ¯ Filtros Inteligentes
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()